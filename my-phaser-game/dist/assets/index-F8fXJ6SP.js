var t=Object.defineProperty,e=(e,i,o)=>((e,i,o)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o)(e,"symbol"!=typeof i?i+"":i,o);import{p as i}from"./phaser-CwoquCe3.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class o extends i.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}const s=class t{constructor(i,o,s){e(this,"type"),e(this,"shape"),e(this,"color"),e(this,"x"),e(this,"y"),this.type=i,this.shape=JSON.parse(JSON.stringify(t.SHAPES[i])),this.color=t.COLORS[i],this.x=o,this.y=s}rotateLeft(){if("O"===this.type)return;const t=this.shape.length,e=Array(t).fill(0).map((()=>Array(t).fill(0)));for(let i=0;i<t;i++)for(let o=0;o<t;o++)e[t-1-o][i]=this.shape[i][o];this.shape=e}rotateRight(){if("O"===this.type)return;const t=this.shape.length,e=Array(t).fill(0).map((()=>Array(t).fill(0)));for(let i=0;i<t;i++)for(let o=0;o<t;o++)e[o][t-1-i]=this.shape[i][o];this.shape=e}static getRandomTetromino(e,i){const o=["I","O","T","S","Z","J","L"],s=o[Math.floor(Math.random()*o.length)];return new t(s,e,i)}getData(){return{type:this.type,color:this.color,shape:this.shape}}};e(s,"SHAPES",{I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[1,1],[1,1]],T:[[0,1,0],[1,1,1],[0,0,0]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]]}),e(s,"COLORS",{I:65535,O:16776960,T:8388736,S:65280,Z:16711680,J:255,L:16744192});let n=s;class r{constructor(){e(this,"width",10),e(this,"height",20),e(this,"grid"),e(this,"currentTetromino",null),e(this,"nextTetromino",null),e(this,"clearedLines",0),e(this,"gameOver",!1),e(this,"onLineClear",null),e(this,"onGameOver",null),this.grid=Array(this.height).fill(0).map((()=>Array(this.width).fill(0))),this.generateNewTetromino()}getGrid(){return this.grid}getCurrentTetromino(){return this.currentTetromino}getNextTetromino(){return this.nextTetromino}getClearedLines(){return this.clearedLines}isGameOver(){return this.gameOver}setOnLineClear(t){this.onLineClear=t}setOnGameOver(t){this.onGameOver=t}generateNewTetromino(){this.nextTetromino?(this.currentTetromino=this.nextTetromino,this.currentTetromino.x=Math.floor(this.width/2)-Math.floor(this.currentTetromino.shape[0].length/2),this.currentTetromino.y=0):this.currentTetromino=n.getRandomTetromino(Math.floor(this.width/2)-1,0),this.nextTetromino=n.getRandomTetromino(0,0),this.checkCollision()&&(this.gameOver=!0,this.onGameOver&&this.onGameOver())}moveLeft(){return!(!this.currentTetromino||this.gameOver||(this.currentTetromino.x--,this.checkCollision()&&(this.currentTetromino.x++,1)))}moveRight(){return!(!this.currentTetromino||this.gameOver||(this.currentTetromino.x++,this.checkCollision()&&(this.currentTetromino.x--,1)))}moveDown(){return!(!this.currentTetromino||this.gameOver||(this.currentTetromino.y++,this.checkCollision()&&(this.currentTetromino.y--,this.lockTetromino(),1)))}rotateLeft(){return!(!this.currentTetromino||this.gameOver||(this.currentTetromino.rotateLeft(),this.checkCollision()&&(this.currentTetromino.rotateRight(),1)))}rotateRight(){return!(!this.currentTetromino||this.gameOver||(this.currentTetromino.rotateRight(),this.checkCollision()&&(this.currentTetromino.rotateLeft(),1)))}hardDrop(){if(this.currentTetromino&&!this.gameOver)for(;this.moveDown(););}checkCollision(){if(!this.currentTetromino)return!1;const t=this.currentTetromino.shape,e=this.currentTetromino.x,i=this.currentTetromino.y;for(let o=0;o<t.length;o++)for(let s=0;s<t[o].length;s++)if(0!==t[o][s]){const t=e+s,n=i+o;if(t<0||t>=this.width||n<0||n>=this.height)return!0;if(n>=0&&0!==this.grid[n][t])return!0}return!1}lockTetromino(){if(!this.currentTetromino)return;const t=this.currentTetromino.shape,e=this.currentTetromino.x,i=this.currentTetromino.y,o=this.currentTetromino.color;for(let n=0;n<t.length;n++)for(let s=0;s<t[n].length;s++)if(0!==t[n][s]){const t=e+s,r=i+n;t>=0&&t<this.width&&r>=0&&r<this.height&&(this.grid[r][t]=o)}const s=this.clearLines();s>0&&(this.clearedLines+=s,this.onLineClear&&this.onLineClear(s)),this.generateNewTetromino()}clearLines(){let t=0;for(let e=this.height-1;e>=0;e--){let i=!0;for(let t=0;t<this.width;t++)if(0===this.grid[e][t]){i=!1;break}if(i){for(let t=0;t<this.width;t++)this.grid[e][t]=0;for(let t=e;t>0;t--)for(let e=0;e<this.width;e++)this.grid[t][e]=this.grid[t-1][e];for(let t=0;t<this.width;t++)this.grid[0][t]=0;t++,e++}}return t}reset(){this.grid=Array(this.height).fill(0).map((()=>Array(this.width).fill(0))),this.currentTetromino=null,this.nextTetromino=null,this.clearedLines=0,this.gameOver=!1,this.generateNewTetromino()}update(){this.gameOver||this.moveDown()}}class a{constructor(t,i,o,s){e(this,"scene"),e(this,"board"),e(this,"blockSize",30),e(this,"boardX"),e(this,"boardY"),e(this,"boardGraphics"),e(this,"gridGraphics"),e(this,"tetrominoGraphics"),e(this,"nextTetrominoGraphics"),e(this,"boardBlocks"),e(this,"tetrominoBlocks"),e(this,"nextTetrominoBlocks"),e(this,"linesText"),e(this,"nextText"),e(this,"gameOverText"),e(this,"instructionsText"),this.scene=t,this.board=i,this.boardX=o,this.boardY=s,this.boardGraphics=this.scene.add.graphics(),this.gridGraphics=this.scene.add.graphics(),this.tetrominoGraphics=this.scene.add.graphics(),this.nextTetrominoGraphics=this.scene.add.graphics(),this.boardBlocks=this.scene.add.container(0,0),this.tetrominoBlocks=this.scene.add.container(0,0),this.nextTetrominoBlocks=this.scene.add.container(0,0),this.linesText=this.scene.add.text(this.boardX+this.board.width*this.blockSize+20,this.boardY,"Lines: 0",{fontFamily:"Arial",fontSize:"24px",color:"#ffffff",stroke:"#000000",strokeThickness:4}),this.nextText=this.scene.add.text(this.boardX+this.board.width*this.blockSize+20,this.boardY+60,"Next:",{fontFamily:"Arial",fontSize:"24px",color:"#ffffff",stroke:"#000000",strokeThickness:4}),this.gameOverText=this.scene.add.text(this.boardX+this.board.width*this.blockSize/2,this.boardY+this.board.height*this.blockSize/2,"GAME OVER\nPress R to restart",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:6,align:"center"}),this.gameOverText.setOrigin(.5),this.gameOverText.setVisible(!1),this.instructionsText=this.scene.add.text(this.boardX+this.board.width*this.blockSize+20,this.boardY+200,"操作方法:\n\n←→: 移動\n↓: 落下\nZ: 左回転\nX: 右回転\nR: リセット",{fontFamily:"Arial",fontSize:"18px",color:"#ffffff",stroke:"#000000",strokeThickness:3}),this.drawBoard(),this.drawGrid()}update(){this.boardBlocks.removeAll(!0),this.tetrominoBlocks.removeAll(!0),this.nextTetrominoBlocks.removeAll(!0),this.drawBoard(),this.drawTetromino(),this.drawNextTetromino(),this.updateTexts(),this.gameOverText.setVisible(this.board.isGameOver())}drawBoard(){this.boardGraphics.clear(),this.boardGraphics.fillStyle(0,.8),this.boardGraphics.fillRect(this.boardX,this.boardY,this.board.width*this.blockSize,this.board.height*this.blockSize);const t=this.board.getGrid();for(let e=0;e<this.board.height;e++)for(let i=0;i<this.board.width;i++)0!==t[e][i]&&this.drawBlock(this.boardGraphics,this.boardX+i*this.blockSize,this.boardY+e*this.blockSize,t[e][i])}drawGrid(){this.gridGraphics.clear(),this.gridGraphics.lineStyle(1,3355443,.5);for(let t=0;t<=this.board.width;t++)this.gridGraphics.beginPath(),this.gridGraphics.moveTo(this.boardX+t*this.blockSize,this.boardY),this.gridGraphics.lineTo(this.boardX+t*this.blockSize,this.boardY+this.board.height*this.blockSize),this.gridGraphics.closePath(),this.gridGraphics.strokePath();for(let t=0;t<=this.board.height;t++)this.gridGraphics.beginPath(),this.gridGraphics.moveTo(this.boardX,this.boardY+t*this.blockSize),this.gridGraphics.lineTo(this.boardX+this.board.width*this.blockSize,this.boardY+t*this.blockSize),this.gridGraphics.closePath(),this.gridGraphics.strokePath()}drawTetromino(){this.tetrominoGraphics.clear();const t=this.board.getCurrentTetromino();if(!t)return;const e=t.shape,i=t.x,o=t.y,s=t.color;for(let n=0;n<e.length;n++)for(let t=0;t<e[n].length;t++)0!==e[n][t]&&this.drawBlock(this.tetrominoGraphics,this.boardX+(i+t)*this.blockSize,this.boardY+(o+n)*this.blockSize,s)}drawNextTetromino(){this.nextTetrominoGraphics.clear();const t=this.board.getNextTetromino();if(!t)return;const e=t.shape,i=t.color,o=this.boardX+this.board.width*this.blockSize+50,s=this.boardY+100;for(let n=0;n<e.length;n++)for(let t=0;t<e[n].length;t++)0!==e[n][t]&&this.drawBlock(this.nextTetrominoGraphics,o+t*this.blockSize,s+n*this.blockSize,i)}drawBlock(t,e,i,o){const s=this.scene.add.graphics();s.fillStyle(o,1),s.fillRect(e+1,i+1,this.blockSize-2,this.blockSize-2);const n=this.scene.add.graphics();n.fillStyle(16777215,.5),n.fillRect(e+1,i+1,this.blockSize-2,5),n.fillRect(e+1,i+1,5,this.blockSize-2);const r=this.scene.add.graphics();r.fillStyle(0,.3),r.fillRect(e+this.blockSize-6,i+1,5,this.blockSize-2),r.fillRect(e+1,i+this.blockSize-6,this.blockSize-2,5);const a=this.scene.add.graphics();a.fillStyle(16777215,.2),a.fillRect(e+6,i+6,this.blockSize-12,this.blockSize-12),t===this.boardGraphics?(this.boardBlocks.add(s),this.boardBlocks.add(n),this.boardBlocks.add(r),this.boardBlocks.add(a)):t===this.tetrominoGraphics?(this.tetrominoBlocks.add(s),this.tetrominoBlocks.add(n),this.tetrominoBlocks.add(r),this.tetrominoBlocks.add(a)):t===this.nextTetrominoGraphics&&(this.nextTetrominoBlocks.add(s),this.nextTetrominoBlocks.add(n),this.nextTetrominoBlocks.add(r),this.nextTetrominoBlocks.add(a)),t.lineStyle(1,0,.5),t.strokeRect(e,i,this.blockSize,this.blockSize)}updateTexts(){this.linesText.setText(`Lines: ${this.board.getClearedLines()}`)}showLineClearEffect(t){const e=this.scene.add.graphics();e.fillStyle(16777215,.8);for(const s of t)e.fillRect(this.boardX,this.boardY+s*this.blockSize,this.board.width*this.blockSize,this.blockSize);for(const s of t)for(let t=0;t<20;t++){const t=this.boardX+Math.random()*this.board.width*this.blockSize,e=this.boardY+s*this.blockSize+this.blockSize/2,i=this.scene.add.star(t,e,5,4,8,16776960,1);this.scene.tweens.add({targets:i,x:t+(60*Math.random()-30),y:e+(60*Math.random()-30),scale:{from:.5,to:0},alpha:{from:1,to:0},duration:800,ease:"Power2",onComplete:()=>{i.destroy()}})}let i=0;const o=this.scene.time.addEvent({delay:100,callback:()=>{if(i++,e.clear(),i%2==0){e.fillStyle(16777215,.8);for(const i of t)e.fillRect(this.boardX,this.boardY+i*this.blockSize,this.board.width*this.blockSize,this.blockSize)}i>=6&&(o.destroy(),e.destroy())},callbackScope:this,loop:!0});console.log("Line clear effect shown for lines:",t)}showDropEffect(t){if(!t)return;console.log("Drop effect shown for tetromino at position:",t.x,t.y);const e=t.shape,i=t.x,o=t.y;for(let s=0;s<e.length;s++)for(let t=0;t<e[s].length;t++)if(0!==e[s][t]){const e=this.boardX+(i+t)*this.blockSize+this.blockSize/2,n=this.boardY+(o+s)*this.blockSize+this.blockSize/2,r=this.scene.add.circle(e,n,this.blockSize/2,16777215,.5);this.scene.tweens.add({targets:r,scale:2,alpha:0,duration:300,ease:"Power2",onComplete:()=>{r.destroy()}});for(let t=0;t<5;t++){const t=Math.random()*Math.PI*2,i=Math.random()*this.blockSize/2,o=e+Math.cos(t)*i,s=n+Math.sin(t)*i,r=this.scene.add.circle(o,s,2,16777215,1);this.scene.tweens.add({targets:r,x:o+Math.cos(t)*this.blockSize,y:s+Math.sin(t)*this.blockSize,alpha:0,duration:500,ease:"Power2",onComplete:()=>{r.destroy()}})}}}showGameOverEffect(){const t=this.scene.add.graphics();t.fillStyle(16711680,.5),t.fillRect(this.boardX,this.boardY,this.board.width*this.blockSize,this.board.height*this.blockSize),this.scene.tweens.add({targets:t,alpha:0,duration:1e3,yoyo:!0,repeat:2,onComplete:()=>{t.destroy()}});const e=this.boardX+this.board.width*this.blockSize/2,i=this.boardY+this.board.height*this.blockSize/2,o=this.scene.add.circle(e,i,10,16711680,1);this.scene.tweens.add({targets:o,scale:20,alpha:0,duration:1e3,ease:"Power2",onComplete:()=>{o.destroy()}});for(let s=0;s<30;s++){const t=Math.random()*Math.PI*2,o=Math.random()*this.blockSize*5,s=e,n=i,r=this.scene.add.rectangle(s,n,10*Math.random()+5,10*Math.random()+5,16711680,1);this.scene.tweens.add({targets:r,x:s+Math.cos(t)*o,y:n+Math.sin(t)*o,angle:360*Math.random(),alpha:0,duration:1e3+500*Math.random(),ease:"Power2",onComplete:()=>{r.destroy()}})}}}const h=class t{constructor(t){e(this,"scene"),e(this,"sounds",new Map),e(this,"soundEnabled",!0),e(this,"bgmEnabled",!0),e(this,"bgm",null),e(this,"audioContext",null),e(this,"playingSound",{move:!1,rotate:!1,drop:!1,line_clear_1:!1,line_clear_2:!1,line_clear_3:!1,line_clear_4:!1,level_up:!1,game_over:!1}),e(this,"soundTimeouts",{}),this.scene=t,this.createSounds()}createSounds(){this.createDirectSound(t.SOUND_KEYS.MOVE,220,.1),this.createDirectSound(t.SOUND_KEYS.ROTATE,330,.15),this.createDirectSound(t.SOUND_KEYS.DROP,165,.2),this.createDirectSound(t.SOUND_KEYS.LINE_CLEAR_1,440,.3),this.createDirectSound(t.SOUND_KEYS.LINE_CLEAR_2,523.25,.4),this.createDirectSound(t.SOUND_KEYS.LINE_CLEAR_3,659.25,.5),this.createDirectSound(t.SOUND_KEYS.LINE_CLEAR_4,880,.6),this.createDirectSound(t.SOUND_KEYS.LEVEL_UP,523.25,.5),this.createDirectSound(t.SOUND_KEYS.GAME_OVER,196,.8)}createDirectSound(e,i,o){try{const s=e.toLowerCase(),n={play:n=>{try{if(!this.soundEnabled)return;if(this.playingSound[s])return void console.log(`Sound ${e} is already playing, skipping`);this.ensureAudioContext(),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state&&this.audioContext.resume();const r=this.audioContext.createOscillator(),a=this.audioContext.createGain();switch(e){case t.SOUND_KEYS.MOVE:r.type="sine";break;case t.SOUND_KEYS.ROTATE:r.type="square";break;case t.SOUND_KEYS.DROP:r.type="sine";break;case t.SOUND_KEYS.LINE_CLEAR_1:case t.SOUND_KEYS.LINE_CLEAR_2:case t.SOUND_KEYS.LINE_CLEAR_3:case t.SOUND_KEYS.LINE_CLEAR_4:r.type="square";break;case t.SOUND_KEYS.LEVEL_UP:case t.SOUND_KEYS.GAME_OVER:r.type="sawtooth";break;default:r.type="sine"}r.frequency.setValueAtTime(i,this.audioContext.currentTime);const h=void 0!==(null==n?void 0:n.volume)?2*n.volume:1;a.gain.setValueAtTime(h,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+o),r.connect(a),a.connect(this.audioContext.destination),this.playingSound[s]=!0,r.start(),r.stop(this.audioContext.currentTime+o),this.soundTimeouts[s]&&window.clearTimeout(this.soundTimeouts[s]),this.soundTimeouts[s]=window.setTimeout((()=>{this.playingSound[s]=!1,console.log(`Sound ${e} playback completed`)}),1e3*o+50),r.onended=()=>{r.disconnect(),a.disconnect()},console.log(`Playing sound ${e} with frequency ${i} and volume ${h}`)}catch(r){console.warn(`Error playing sound ${e}:`,r),this.playingSound[s]=!1}}};this.sounds.set(e,n)}catch(s){console.warn(`Error creating sound ${e}:`,s)}}ensureAudioContext(){try{const t=new(window.AudioContext||window.webkitAudioContext);"suspended"===t.state&&t.resume();const e=t.createOscillator(),i=t.createGain();i.gain.value=.001,e.connect(i),i.connect(t.destination),e.start(),e.stop(t.currentTime+.001),e.onended=()=>{e.disconnect(),i.disconnect()}}catch(t){console.warn("Error ensuring audio context:",t)}}preload(){try{this.scene.load.audio(t.SOUND_KEYS.MOVE,"assets/sounds/move.mp3"),this.scene.load.audio(t.SOUND_KEYS.ROTATE,"assets/sounds/rotate.mp3"),this.scene.load.audio(t.SOUND_KEYS.DROP,"assets/sounds/drop.mp3"),this.scene.load.audio(t.SOUND_KEYS.LINE_CLEAR_1,"assets/sounds/line_clear_1.mp3"),this.scene.load.audio(t.SOUND_KEYS.LINE_CLEAR_2,"assets/sounds/line_clear_2.mp3"),this.scene.load.audio(t.SOUND_KEYS.LINE_CLEAR_3,"assets/sounds/line_clear_3.mp3"),this.scene.load.audio(t.SOUND_KEYS.LINE_CLEAR_4,"assets/sounds/line_clear_4.mp3"),this.scene.load.audio(t.SOUND_KEYS.LEVEL_UP,"assets/sounds/level_up.mp3"),this.scene.load.audio(t.SOUND_KEYS.GAME_OVER,"assets/sounds/game_over.mp3"),this.createTetrisBGM()}catch(e){console.warn("Error loading sound files:",e)}}createTetrisBGM(){try{new(window.AudioContext||window.webkitAudioContext);const e=[{note:"E5",duration:.25},{note:"B4",duration:.125},{note:"C5",duration:.125},{note:"D5",duration:.25},{note:"C5",duration:.125},{note:"B4",duration:.125},{note:"A4",duration:.25},{note:"A4",duration:.125},{note:"C5",duration:.125},{note:"E5",duration:.25},{note:"D5",duration:.125},{note:"C5",duration:.125},{note:"B4",duration:.375},{note:"C5",duration:.125},{note:"D5",duration:.25},{note:"E5",duration:.25},{note:"C5",duration:.25},{note:"A4",duration:.25},{note:"A4",duration:.375},{note:"D5",duration:.125},{note:"F5",duration:.25},{note:"A5",duration:.25},{note:"G5",duration:.125},{note:"F5",duration:.125},{note:"E5",duration:.375},{note:"C5",duration:.125},{note:"E5",duration:.25},{note:"D5",duration:.125},{note:"C5",duration:.125},{note:"B4",duration:.25},{note:"B4",duration:.125},{note:"C5",duration:.125},{note:"D5",duration:.25},{note:"E5",duration:.25},{note:"C5",duration:.25},{note:"A4",duration:.25},{note:"A4",duration:.25}],i={A4:440,B4:493.88,C5:523.25,D5:587.33,E5:659.25,F5:698.46,G5:783.99,A5:880},o={play:t=>{if(this.bgmEnabled)try{this.ensureAudioContext();const o=new(window.AudioContext||window.webkitAudioContext),s=void 0!==(null==t?void 0:t.volume)?t.volume:.3,n=o.createGain();n.gain.value=s,n.connect(o.destination);let r=o.currentTime;const a=t=>{if(t>=e.length)return r=o.currentTime,void a(0);const s=e[t],h=i[s.note],d=s.duration,l=o.createOscillator();l.type="square",l.frequency.value=h;const c=o.createGain();c.gain.setValueAtTime(.001,r),c.gain.linearRampToValueAtTime(.5,r+.01),c.gain.linearRampToValueAtTime(.3,r+.6*d),c.gain.linearRampToValueAtTime(.001,r+d),l.connect(c),c.connect(n),l.start(r),l.stop(r+d),l.onended=()=>{l.disconnect(),c.disconnect(),this.bgmEnabled&&a(t+1)},r+=d};a(0),console.log("Playing BGM")}catch(o){console.warn("Error playing BGM:",o)}},stop:()=>{this.bgmEnabled=!1,console.log("BGM stopped")}};this.bgm=o,this.sounds.set(t.SOUND_KEYS.BGM,o)}catch(e){console.warn("Error creating BGM:",e)}}playMoveSound(){this.playSoundSafely(t.SOUND_KEYS.MOVE,{volume:.5})}playRotateSound(){this.playSoundSafely(t.SOUND_KEYS.ROTATE,{volume:.5})}playDropSound(){this.playSoundSafely(t.SOUND_KEYS.DROP,{volume:.6})}playLineClearSound(e=1){switch(e){case 1:default:this.playSoundSafely(t.SOUND_KEYS.LINE_CLEAR_1,{volume:.7});break;case 2:this.playSoundSafely(t.SOUND_KEYS.LINE_CLEAR_2,{volume:.8});break;case 3:this.playSoundSafely(t.SOUND_KEYS.LINE_CLEAR_3,{volume:.9});break;case 4:this.playSoundSafely(t.SOUND_KEYS.LINE_CLEAR_4,{volume:1})}}playLevelUpSound(){this.playSoundSafely(t.SOUND_KEYS.LEVEL_UP,{volume:.7})}playGameOverSound(){this.playSoundSafely(t.SOUND_KEYS.GAME_OVER,{volume:.7})}playSoundSafely(e,i){if(this.soundEnabled||e===t.SOUND_KEYS.BGM)try{if(this.scene.sound.get(e))return this.scene.sound.play(e,i),void console.log(`Playing sound: ${e} from file`);const t=this.sounds.get(e);t?(t.play(i),console.log(`Playing sound: ${e} from generated sound`)):(console.warn(`Sound not found: ${e}`),this.playFallbackSound(e))}catch(o){console.warn(`Error playing sound ${e}:`,o),this.playFallbackSound(e)}}playBGM(){if(this.bgmEnabled)try{console.log("Starting BGM playback..."),this.ensureAudioContext();const t=new(window.AudioContext||window.webkitAudioContext),e=[{note:"E5",duration:.25},{note:"B4",duration:.125},{note:"C5",duration:.125},{note:"D5",duration:.25},{note:"C5",duration:.125},{note:"B4",duration:.125},{note:"A4",duration:.25},{note:"A4",duration:.125},{note:"C5",duration:.125},{note:"E5",duration:.25},{note:"D5",duration:.125},{note:"C5",duration:.125},{note:"B4",duration:.375},{note:"C5",duration:.125},{note:"D5",duration:.25},{note:"E5",duration:.25},{note:"C5",duration:.25},{note:"A4",duration:.25},{note:"A4",duration:.375}],i={A4:440,B4:493.88,C5:523.25,D5:587.33,E5:659.25,F5:698.46,G5:783.99,A5:880},o=t.createGain();o.gain.value=.3,o.connect(t.destination);let s=t.currentTime;const n=r=>{if(!this.bgmEnabled)return void console.log("BGM disabled, stopping playback");if(r>=e.length)return s=t.currentTime,void n(0);const a=e[r],h=i[a.note],d=a.duration,l=t.createOscillator();l.type="square",l.frequency.value=h;const c=t.createGain();c.gain.setValueAtTime(.001,s),c.gain.linearRampToValueAtTime(.5,s+.01),c.gain.linearRampToValueAtTime(.3,s+.6*d),c.gain.linearRampToValueAtTime(.001,s+d),l.connect(c),c.connect(o),l.start(s),l.stop(s+d),console.log(`Playing BGM note: ${a.note} at time ${s}`),l.onended=()=>{l.disconnect(),c.disconnect(),this.bgmEnabled&&n(r+1)},s+=d};n(0),console.log("BGM playback started")}catch(t){console.warn("Error playing BGM:",t)}}stopBGM(){if(this.bgm)try{this.bgm.stop(),this.bgmEnabled=!1}catch(t){console.warn("Error stopping BGM:",t)}}toggleSound(){return this.soundEnabled=!this.soundEnabled,this.soundEnabled}toggleBGM(){return this.bgmEnabled=!this.bgmEnabled,this.bgmEnabled?this.playBGM():this.stopBGM(),this.bgmEnabled}isSoundEnabled(){return this.soundEnabled}isBGMEnabled(){return this.bgmEnabled}playFallbackSound(e){if(!this.soundEnabled)return;const i=e.toLowerCase();if(this.playingSound[i])console.log(`Sound ${e} is already playing, skipping`);else try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.audioContext.state&&this.audioContext.resume();const o=this.audioContext.createOscillator(),s=this.audioContext.createGain();let n=440,r=.2;switch(e){case t.SOUND_KEYS.MOVE:n=220,r=.1;break;case t.SOUND_KEYS.ROTATE:n=330,r=.15;break;case t.SOUND_KEYS.DROP:n=165,r=.2;break;case t.SOUND_KEYS.LINE_CLEAR_1:n=440,r=.3;break;case t.SOUND_KEYS.LINE_CLEAR_2:n=523.25,r=.4;break;case t.SOUND_KEYS.LINE_CLEAR_3:n=659.25,r=.5;break;case t.SOUND_KEYS.LINE_CLEAR_4:n=880,r=.6;break;case t.SOUND_KEYS.LEVEL_UP:n=523.25,r=.5;break;case t.SOUND_KEYS.GAME_OVER:n=196,r=.8}switch(e){case t.SOUND_KEYS.MOVE:o.type="sine";break;case t.SOUND_KEYS.ROTATE:o.type="square";break;case t.SOUND_KEYS.DROP:o.type="sine";break;case t.SOUND_KEYS.LINE_CLEAR_1:case t.SOUND_KEYS.LINE_CLEAR_2:case t.SOUND_KEYS.LINE_CLEAR_3:case t.SOUND_KEYS.LINE_CLEAR_4:o.type="square";break;case t.SOUND_KEYS.LEVEL_UP:case t.SOUND_KEYS.GAME_OVER:o.type="sawtooth";break;default:o.type="sine"}o.frequency.setValueAtTime(n,this.audioContext.currentTime),s.gain.setValueAtTime(1,this.audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+r),o.connect(s),s.connect(this.audioContext.destination),this.playingSound[i]=!0,o.start(),o.stop(this.audioContext.currentTime+r),console.log(`Playing fallback sound: ${e} with frequency ${n}`),this.soundTimeouts[i]&&window.clearTimeout(this.soundTimeouts[i]),this.soundTimeouts[i]=window.setTimeout((()=>{this.playingSound[i]=!1,console.log(`Sound ${e} playback completed`)}),1e3*r+50),o.onended=()=>{o.disconnect(),s.disconnect()}}catch(o){console.warn(`Error playing fallback sound ${e}:`,o),this.playingSound[i]=!1}}};e(h,"SOUND_KEYS",{MOVE:"move",ROTATE:"rotate",DROP:"drop",LINE_CLEAR_1:"line_clear_1",LINE_CLEAR_2:"line_clear_2",LINE_CLEAR_3:"line_clear_3",LINE_CLEAR_4:"line_clear_4",LEVEL_UP:"level_up",GAME_OVER:"game_over",BGM:"bgm"});let d=h;class l{constructor(t,i,o){e(this,"scene"),e(this,"board"),e(this,"renderer"),e(this,"audio"),e(this,"paused",!1),e(this,"gameSpeed",1e3),e(this,"lastMoveTime",0),e(this,"keyDelay",100),e(this,"lastKeyTime",{left:0,right:0,down:0,z:0,x:0,r:0,m:0,b:0}),e(this,"lastTetrominoY",-1),this.scene=t,this.audio=new d(t),this.board=new r,this.renderer=new a(t,this.board,i,o),this.board.setOnLineClear((t=>{this.audio.playLineClearSound(t);const e=[];let i=this.board.height-1,o=0;for(;i>=0&&o<t;)e.push(i),o++,i--;this.renderer.showLineClearEffect(e)})),this.board.setOnGameOver((()=>{this.audio.playGameOverSound(),this.renderer.showGameOverEffect()})),this.audio.playBGM()}preload(){this.audio.preload()}update(t){if(!this.paused)if(this.isKeyJustDown("R",t))this.reset();else if(this.board.isGameOver())this.renderer.update();else{if(this.handleInput(t),t-this.lastMoveTime>this.gameSpeed){this.lastMoveTime=t;const e=this.board.getCurrentTetromino();let i=-1;e&&(i=e.y),this.board.moveDown()||(this.audio.playDropSound(),e&&i>=0&&i!==this.lastTetrominoY&&this.renderer.showDropEffect(e)),e&&(this.lastTetrominoY=e.y)}this.renderer.update()}}reset(){this.board.reset(),this.lastMoveTime=0,this.paused=!1,this.lastTetrominoY=-1}handleInput(t){if(this.isKeyDown("LEFT")&&t-this.lastKeyTime.left>this.keyDelay&&(this.lastKeyTime.left=t,this.board.moveLeft()&&this.audio.playMoveSound()),this.isKeyDown("RIGHT")&&t-this.lastKeyTime.right>this.keyDelay&&(this.lastKeyTime.right=t,this.board.moveRight()&&this.audio.playMoveSound()),this.isKeyDown("DOWN")&&t-this.lastKeyTime.down>this.keyDelay&&(this.lastKeyTime.down=t,this.board.moveDown()&&this.audio.playMoveSound()),this.isKeyJustDown("Z",t)&&this.board.rotateLeft()&&this.audio.playRotateSound(),this.isKeyJustDown("X",t)&&this.board.rotateRight()&&this.audio.playRotateSound(),this.isKeyJustDown("M",t)){const t=this.audio.toggleSound();console.log("Sound "+(t?"enabled":"disabled")),t&&this.audio.playMoveSound()}if(this.isKeyJustDown("B",t)){const t=this.audio.toggleBGM();console.log("BGM "+(t?"enabled":"disabled"))}}isKeyDown(t){const e=this.scene.input.keyboard;if(!e)return!1;switch(t){case"LEFT":return e.addKey(i.Input.Keyboard.KeyCodes.LEFT).isDown;case"RIGHT":return e.addKey(i.Input.Keyboard.KeyCodes.RIGHT).isDown;case"DOWN":return e.addKey(i.Input.Keyboard.KeyCodes.DOWN).isDown;case"Z":return e.addKey(i.Input.Keyboard.KeyCodes.Z).isDown;case"X":return e.addKey(i.Input.Keyboard.KeyCodes.X).isDown;case"R":return e.addKey(i.Input.Keyboard.KeyCodes.R).isDown;case"M":return e.addKey(i.Input.Keyboard.KeyCodes.M).isDown;case"B":return e.addKey(i.Input.Keyboard.KeyCodes.B).isDown;default:return!1}}isKeyJustDown(t,e){if(!this.scene.input.keyboard)return!1;const i=this.isKeyDown(t),o=this.lastKeyTime[t.toLowerCase()]||0;return!!(i&&e-o>this.keyDelay)&&(this.lastKeyTime[t.toLowerCase()]=e,console.log(`Key ${t} just pressed at time ${e}`),!0)}pause(){this.paused=!0}resume(){this.paused=!1}setGameSpeed(t){this.gameSpeed=t}}class c extends i.Scene{constructor(){super("Game"),e(this,"tetrisGame"),e(this,"titleText"),e(this,"sunGraphics"),e(this,"gridGraphics"),e(this,"mountainsGraphics")}preload(){this.load.audio("move","assets/sounds/move.mp3"),this.load.audio("rotate","assets/sounds/rotate.mp3"),this.load.audio("drop","assets/sounds/drop.mp3"),this.load.audio("line_clear","assets/sounds/line_clear.mp3"),this.load.audio("level_up","assets/sounds/level_up.mp3"),this.load.audio("game_over","assets/sounds/game_over.mp3")}create(){this.createRetrowaveBackground();const t=this.add.graphics();t.fillStyle(26316,.8),t.fillRoundedRect(412,70,200,60,10);const e=this.add.graphics();e.fillStyle(16777215,.2),e.fillRoundedRect(417,75,190,20,8);const i=this.add.graphics();i.lineStyle(3,13158,1),i.strokeRoundedRect(412,70,200,60,10),this.titleText=this.add.text(512,100,"テトーリス",{fontFamily:"Impact, Arial Black",fontSize:36,color:"#ffffff",stroke:"#003366",strokeThickness:4,align:"center"}),this.titleText.setOrigin(.5),this.add.text(512,130,"with コロブチカ",{fontFamily:"Arial",fontSize:18,color:"#ffff00",stroke:"#003366",strokeThickness:2,align:"center"}).setOrigin(.5),this.add.text(514,102,"テトーリス",{fontFamily:"Impact, Arial Black",fontSize:36,color:"#003366",align:"center"}).setOrigin(.5).setAlpha(.5).setDepth(-1),this.tetrisGame=new l(this,362,150),this.input.keyboard&&this.input.keyboard.on("keydown-ESC",(()=>{this.scene.start("MainMenu")}))}update(t,e){this.tetrisGame.update(t)}createRetrowaveBackground(){const t=this.add.graphics();t.fillGradientStyle(51,51,16724838,16724838,1),t.fillRect(0,0,1024,768),t.setDepth(-10),this.tweens.addCounter({from:0,to:1,duration:1e4,repeat:-1,onUpdate:e=>{const i=e.getValue(),o=(30*i+210)%360,s=(30*i+330)%360,n=Phaser.Display.Color.HSVToRGB(o/360,.8,.2),r=Phaser.Display.Color.HSVToRGB(s/360,.8,.4);t.clear(),t.fillGradientStyle(n.color,n.color,r.color,r.color,1),t.fillRect(0,0,1024,768)}})}}class u extends i.Scene{constructor(){super("GameOver"),e(this,"camera"),e(this,"background"),e(this,"gameOverText"),e(this,"scoreText"),e(this,"restartButton"),e(this,"menuButton"),e(this,"score",0)}init(t){this.score=t.score||0}create(){this.camera=this.cameras.main,this.camera.setBackgroundColor(0),this.background=this.add.image(512,384,"background"),this.background.setAlpha(.3),this.gameOverText=this.add.text(512,200,"ゲームオーバー",{fontFamily:"Arial Black",fontSize:64,color:"#ff0000",stroke:"#000000",strokeThickness:8,align:"center"}),this.gameOverText.setOrigin(.5),this.scoreText=this.add.text(512,300,`消去した行数: ${this.score}`,{fontFamily:"Arial",fontSize:32,color:"#ffffff",stroke:"#000000",strokeThickness:4,align:"center"}),this.scoreText.setOrigin(.5),this.restartButton=this.add.text(512,400,"もう一度プレイ",{fontFamily:"Arial",fontSize:28,color:"#ffffff",stroke:"#000000",strokeThickness:4,align:"center"}),this.restartButton.setOrigin(.5),this.restartButton.setInteractive({useHandCursor:!0}),this.restartButton.on("pointerover",(()=>{this.restartButton.setStyle({color:"#ffff00"})})),this.restartButton.on("pointerout",(()=>{this.restartButton.setStyle({color:"#ffffff"})})),this.restartButton.on("pointerdown",(()=>{this.scene.start("Game")})),this.menuButton=this.add.text(512,470,"メインメニューに戻る",{fontFamily:"Arial",fontSize:28,color:"#ffffff",stroke:"#000000",strokeThickness:4,align:"center"}),this.menuButton.setOrigin(.5),this.menuButton.setInteractive({useHandCursor:!0}),this.menuButton.on("pointerover",(()=>{this.menuButton.setStyle({color:"#ffff00"})})),this.menuButton.on("pointerout",(()=>{this.menuButton.setStyle({color:"#ffffff"})})),this.menuButton.on("pointerdown",(()=>{this.scene.start("MainMenu")}))}}class m extends i.Scene{constructor(){super("MainMenu"),e(this,"background"),e(this,"title"),e(this,"startButton"),e(this,"instructionsText"),e(this,"sunGraphics"),e(this,"gridGraphics"),e(this,"mountainsGraphics")}create(){var t;this.createRetrowaveBackground();const e=this.add.graphics();e.fillStyle(26316,1),e.fillRoundedRect(312,150,400,100,16);const i=this.add.graphics();i.fillStyle(16777215,.2),i.fillRoundedRect(322,160,380,40,12);const o=this.add.graphics();o.lineStyle(4,13158,1),o.strokeRoundedRect(312,150,400,100,16),this.title=this.add.text(512,200,"テトーリス",{fontFamily:"Impact, Arial Black",fontSize:72,color:"#ffffff",stroke:"#003366",strokeThickness:6,align:"center"}).setOrigin(.5),this.add.text(512,260,"with コロブチカ",{fontFamily:"Arial",fontSize:28,color:"#ffff00",stroke:"#003366",strokeThickness:4,align:"center"}).setOrigin(.5),this.add.text(516,204,"テトーリス",{fontFamily:"Impact, Arial Black",fontSize:72,color:"#003366",align:"center"}).setOrigin(.5).setAlpha(.5).setDepth(-1),this.startButton=this.add.text(512,400,"ゲームスタート",{fontFamily:"Arial",fontSize:32,color:"#ffffff",stroke:"#000000",strokeThickness:4,align:"center"}).setOrigin(.5),this.startButton.setInteractive({useHandCursor:!0}),this.startButton.on("pointerover",(()=>{this.startButton.setStyle({color:"#ffff00"})})),this.startButton.on("pointerout",(()=>{this.startButton.setStyle({color:"#ffffff"})})),this.startButton.on("pointerdown",(()=>{this.scene.start("Game")})),null==(t=this.input.keyboard)||t.on("keydown",(()=>{this.scene.start("Game")})),this.instructionsText=this.add.text(512,500,"操作方法:\n←→: 移動  ↓: 落下\nZ: 左回転  X: 右回転\nR: リセット  ESC: メニューに戻る\nM: サウンドオンオフ  B: BGMオンオフ",{fontFamily:"Arial",fontSize:20,color:"#ffffff",stroke:"#000000",strokeThickness:3,align:"center"}).setOrigin(.5);const s=this.add.text(512,600,"⚠️ 注意: このゲームは音が鳴ります ⚠️",{fontFamily:"Arial",fontSize:24,color:"#ffff00",stroke:"#ff0000",strokeThickness:4,align:"center"}).setOrigin(.5);this.tweens.add({targets:s,alpha:.3,duration:800,ease:"Sine.easeInOut",yoyo:!0,repeat:-1})}createRetrowaveBackground(){const t=this.add.graphics();t.fillGradientStyle(51,51,16724838,16724838,1),t.fillRect(0,0,1024,768),t.setDepth(-10),this.tweens.addCounter({from:0,to:1,duration:1e4,repeat:-1,onUpdate:e=>{const i=e.getValue(),o=(30*i+210)%360,s=(30*i+330)%360,n=Phaser.Display.Color.HSVToRGB(o/360,.8,.2),r=Phaser.Display.Color.HSVToRGB(s/360,.8,.4);t.clear(),t.fillGradientStyle(n.color,n.color,r.color,r.color,1),t.fillRect(0,0,1024,768)}})}}class p extends i.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.text(512,320,"ロード中...",{fontFamily:"Arial",fontSize:24,color:"#ffffff"}).setOrigin(.5),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const t=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",(e=>{t.width=4+460*e}))}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png"),this.load.image("block","logo.png"),this.load.audio("move","sounds/move.mp3"),this.load.audio("rotate","sounds/rotate.mp3"),this.load.audio("drop","sounds/drop.mp3"),this.load.audio("line_clear","sounds/line_clear.mp3"),this.load.audio("level_up","sounds/level_up.mp3"),this.load.audio("game_over","sounds/game_over.mp3"),this.createDummySounds()}create(){this.scene.start("MainMenu")}createDummySounds(){var t;const e=["sounds/move.mp3","sounds/rotate.mp3","sounds/drop.mp3","sounds/line_clear.mp3","sounds/level_up.mp3","sounds/game_over.mp3"];for(const i of e)this.cache.audio.get((null==(t=i.split("/").pop())?void 0:t.split(".")[0])||"")}}const f={type:Phaser.AUTO,width:1024,height:768,parent:"game-container",backgroundColor:"#028af8",scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},scene:[o,p,m,c,u]};new i.Game(f);
